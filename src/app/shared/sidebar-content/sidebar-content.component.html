<mat-nav-list>
  <mat-accordion>
    <ng-container *ngFor="let item of menuItems$ | async">
      <ng-container
        *ngTemplateOutlet="
          item.children ? hasChildren : noChildren;
          context: { item: item }
        "
      >
      </ng-container>
    </ng-container>
  </mat-accordion>
</mat-nav-list>

<ng-template #hasChildren let-item="item" let-parentRoute="parentRoute || ''">
  <mat-expansion-panel
    [expanded]="isMenuExpanded(parentRoute + '' + item.route)"
    (opened)="setMenuExpanded(parentRoute + '' + item.route)"
  >
    <mat-expansion-panel-header>
      <mat-panel-title>
        {{ item.displayName }}
      </mat-panel-title>
    </mat-expansion-panel-header>
    <mat-accordion>
      <ng-container *ngFor="let subitem of item.children">
        <ng-container
          *ngTemplateOutlet="
            subitem.children ? hasChildren : noChildren;
            context: {
              item: subitem,
              parentRoute: parentRoute + '' + item.route
            }
          "
        >
        </ng-container>
      </ng-container>
    </mat-accordion>
  </mat-expansion-panel>
</ng-template>

<ng-template #noChildren let-item="item" let-parentRoute="parentRoute || ''">
  <a
    mat-list-item
    routerLink="{{ parentRoute }}{{ item.route }}"
    (click)="!parentRoute ? setMenuExpanded(item.route) : null"
  >
    {{ item.displayName }}
  </a>
</ng-template>
